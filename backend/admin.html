<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventario Pro - Admin</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg:#f1f5f9; --surface:#fff; --surface-2:#f8fafc;
            --border:#e2e8f0; --border-strong:#cbd5e1;
            --text:#0f172a; --text-2:#475569; --text-3:#94a3b8;
            --primary:#3b82f6; --primary-d:#2563eb; --primary-bg:#eff6ff;
            --success:#10b981; --success-d:#059669; --success-bg:#ecfdf5;
            --danger:#ef4444; --danger-d:#dc2626; --danger-bg:#fef2f2;
            --warning:#f59e0b; --warning-d:#d97706; --warning-bg:#fffbeb;
            --header:#0f172a; --header-2:#1e293b;
            --r-sm:6px; --r-md:10px; --r-lg:14px; --r-xl:18px;
            --sh-sm:0 1px 2px rgba(0,0,0,.05);
            --sh-md:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.04);
            --sh-lg:0 4px 16px rgba(0,0,0,.08),0 1px 4px rgba(0,0,0,.04);
            --sh-xl:0 12px 40px rgba(0,0,0,.15),0 4px 12px rgba(0,0,0,.08);
        }
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:14px;line-height:1.5;-webkit-font-smoothing:antialiased}

        /* ========= LOGIN ========= */
        .login-page{display:flex;justify-content:center;align-items:center;min-height:100vh;
            background:linear-gradient(135deg,#0f172a 0%,#1e293b 50%,#0f1f3a 100%);
            padding:20px;position:relative;overflow:hidden}
        .login-page::before{content:'';position:absolute;inset:0;
            background:radial-gradient(ellipse 80% 60% at 50% -10%,rgba(59,130,246,.18),transparent),
                        radial-gradient(ellipse 50% 40% at 80% 80%,rgba(99,102,241,.12),transparent);
            pointer-events:none}
        .login-box{background:rgba(255,255,255,.98);border:1px solid rgba(255,255,255,.2);
            padding:40px 36px;border-radius:var(--r-xl);width:100%;max-width:380px;
            box-shadow:var(--sh-xl);position:relative;backdrop-filter:blur(10px)}
        .login-logo{width:52px;height:52px;background:linear-gradient(135deg,var(--primary),#6366f1);
            border-radius:14px;display:flex;align-items:center;justify-content:center;
            margin:0 auto 20px;box-shadow:0 4px 14px rgba(59,130,246,.35)}
        .login-logo svg{width:28px;height:28px;color:#fff;stroke:currentColor}
        .login-box h1{font-size:1.5rem;font-weight:700;color:var(--text);text-align:center;margin-bottom:4px}
        .login-box>.subtitle{font-size:.875rem;color:var(--text-3);text-align:center;margin-bottom:28px}
        .form-group{margin-bottom:16px}
        .form-group label{display:block;font-size:.8rem;font-weight:600;color:var(--text-2);margin-bottom:6px;letter-spacing:.01em}
        .form-group input,.form-group select{width:100%;padding:10px 14px;border:1.5px solid var(--border);
            border-radius:var(--r-md);font-size:.9rem;outline:none;transition:all .2s;
            background:var(--surface-2);color:var(--text);font-family:inherit}
        .form-group input:focus,.form-group select:focus{border-color:var(--primary);
            background:var(--surface);box-shadow:0 0 0 3px rgba(59,130,246,.12)}
        .error-text{color:var(--danger);font-size:.82rem;margin-top:8px;display:flex;align-items:center;gap:4px}

        /* ========= BUTTONS ========= */
        .btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;
            border:1.5px solid var(--border);border-radius:var(--r-md);cursor:pointer;
            font-size:.84rem;font-weight:500;background:var(--surface);color:var(--text-2);
            transition:all .18s;white-space:nowrap;font-family:inherit;line-height:1}
        .btn:hover{background:var(--surface-2);border-color:var(--border-strong);color:var(--text)}
        .btn:active{transform:scale(.98)}
        .btn svg{width:14px;height:14px;flex-shrink:0}
        .btn-primary{background:var(--primary);color:#fff;border-color:var(--primary)}
        .btn-primary:hover{background:var(--primary-d);border-color:var(--primary-d);color:#fff}
        .btn-danger{background:var(--danger);color:#fff;border-color:var(--danger)}
        .btn-danger:hover{background:var(--danger-d);border-color:var(--danger-d);color:#fff}
        .btn-success{background:var(--success);color:#fff;border-color:var(--success)}
        .btn-success:hover{background:var(--success-d);border-color:var(--success-d);color:#fff}
        .btn-warning{background:var(--warning);color:#fff;border-color:var(--warning)}
        .btn-warning:hover{background:var(--warning-d);border-color:var(--warning-d);color:#fff}
        .btn-ghost{background:transparent;border-color:transparent;color:var(--text-2)}
        .btn-ghost:hover{background:var(--surface-2);border-color:var(--border);color:var(--text)}
        .btn-block{width:100%;justify-content:center;padding:11px 14px;font-size:.9rem;font-weight:600}
        .btn-sm{padding:5px 10px;font-size:.78rem;border-radius:var(--r-sm)}
        .btn-lg{padding:10px 20px;font-size:.92rem;font-weight:600}
        .btn-icon-del{background:none;border:none;cursor:pointer;padding:5px;border-radius:var(--r-sm);
            color:var(--danger);transition:all .15s;display:inline-flex;align-items:center;justify-content:center}
        .btn-icon-del:hover{background:var(--danger-bg);color:var(--danger-d)}
        .btn-icon-del svg{width:15px;height:15px}
        /* legacy alias */
        .btn-icon{background:none;border:none;cursor:pointer;font-size:1.1rem;padding:5px 7px;border-radius:var(--r-sm);color:var(--danger)}
        .btn-icon:hover{background:var(--danger-bg)}

        /* ========= HEADER + NAV ========= */
        .app-header{background:var(--header);color:#fff;position:sticky;top:0;z-index:100;
            box-shadow:0 1px 0 rgba(255,255,255,.06)}
        .app-header-top{display:flex;justify-content:space-between;align-items:center;padding:12px 24px}
        .app-brand{display:flex;align-items:center;gap:10px}
        .app-brand-icon{width:30px;height:30px;background:linear-gradient(135deg,var(--primary),#6366f1);
            border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .app-brand-icon svg{width:17px;height:17px;color:#fff}
        .app-header-top h2{font-size:1rem;font-weight:700;letter-spacing:-.01em}
        .app-header-top .right{display:flex;align-items:center;gap:10px}
        .app-header-top .right span{font-size:.82rem;color:#94a3b8}
        .btn-header{padding:6px 12px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
            border-radius:var(--r-md);color:#e2e8f0;font-size:.8rem;font-weight:500;cursor:pointer;
            transition:all .18s;font-family:inherit;display:inline-flex;align-items:center;gap:5px}
        .btn-header:hover{background:rgba(255,255,255,.14);border-color:rgba(255,255,255,.2)}
        .btn-header svg{width:13px;height:13px}
        .app-nav{display:flex;align-items:center;padding:0 20px;
            border-top:1px solid rgba(255,255,255,.07);gap:2px}
        .app-nav-btn{display:flex;align-items:center;gap:6px;padding:9px 13px;border:none;
            background:none;color:#64748b;font-size:.82rem;font-weight:500;cursor:pointer;
            border-radius:var(--r-md);transition:all .18s;white-space:nowrap;margin:4px 0;font-family:inherit}
        .app-nav-btn:hover{color:#e2e8f0;background:rgba(255,255,255,.07)}
        .app-nav-btn.active{color:#93c5fd;background:rgba(59,130,246,.15)}
        .app-nav-btn svg{width:15px;height:15px;flex-shrink:0}
        .nav-sep{width:1px;height:18px;background:rgba(255,255,255,.1);margin:0 6px;flex-shrink:0}
        .nav-spacer{flex:1}
        .nav-badge{background:var(--primary);color:#fff;font-size:.65rem;font-weight:700;padding:1px 6px;border-radius:10px;margin-left:2px}
        .breadcrumb{display:flex;align-items:center;gap:4px;padding:0 6px;color:#64748b;font-size:.82rem}
        .breadcrumb svg{width:14px;height:14px;flex-shrink:0}
        .breadcrumb-current{color:#cbd5e1;font-weight:500}

        /* ========= LAYOUT ========= */
        .main-content{max-width:1440px;margin:0 auto;padding:24px 20px}
        .actions-bar{display:flex;gap:10px;margin-bottom:20px;align-items:center;flex-wrap:wrap}
        .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-lg);
            padding:20px;margin-bottom:20px;box-shadow:var(--sh-md)}
        .card h3{font-size:.95rem;font-weight:600;color:var(--text);margin-bottom:16px}
        .card-header{display:flex;justify-content:space-between;align-items:center;
            margin-bottom:16px;flex-wrap:wrap;gap:8px;padding-bottom:14px;
            border-bottom:1px solid var(--border)}
        .card-header h3{margin:0;font-size:.95rem;font-weight:600;color:var(--text)}
        .card-header .tools{display:flex;gap:8px;align-items:center}
        .card-header input[type=text]{padding:7px 11px;border:1.5px solid var(--border);
            border-radius:var(--r-sm);font-size:.82rem;outline:none;width:200px;
            transition:border .2s;font-family:inherit;background:var(--surface-2)}
        .card-header input[type=text]:focus{border-color:var(--primary);box-shadow:0 0 0 2px rgba(59,130,246,.1)}

        /* ========= TABLES ========= */
        table{width:100%;border-collapse:collapse;font-size:.83rem}
        thead th{text-align:left;padding:9px 10px;background:var(--surface-2);
            border-bottom:1.5px solid var(--border);font-weight:600;color:var(--text-3);
            white-space:nowrap;position:sticky;top:0;z-index:1;font-size:.75rem;
            text-transform:uppercase;letter-spacing:.04em}
        tbody td{padding:9px 10px;border-bottom:1px solid var(--border);vertical-align:middle;color:var(--text-2)}
        tbody td:first-child{color:var(--text)}
        tbody tr:last-child td{border-bottom:none}
        tbody tr:hover{background:var(--primary-bg)}
        tbody tr:hover td{color:var(--text)}
        .table-scroll{overflow-x:auto;max-height:500px;overflow-y:auto;border-radius:var(--r-md);border:1px solid var(--border)}
        tfoot td{font-weight:700;background:var(--surface-2);border-top:1.5px solid var(--border);color:var(--text)}

        /* ========= BADGES ========= */
        .badge{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;font-size:.73rem;font-weight:600;letter-spacing:.01em}
        .badge::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor;opacity:.6}
        .badge-preparacion{background:#fef3c7;color:#92400e}
        .badge-activo{background:var(--success-bg);color:#065f46}
        .badge-cerrado{background:#f1f5f9;color:#475569}

        /* ========= TABS ========= */
        .nav-tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--surface-2);
            border:1px solid var(--border);border-radius:var(--r-md);padding:4px;width:fit-content}
        .tab-btn{padding:7px 18px;border:none;background:none;cursor:pointer;font-size:.85rem;
            font-weight:500;color:var(--text-3);border-radius:var(--r-sm);transition:all .18s;font-family:inherit}
        .tab-btn.active{background:var(--surface);color:var(--primary);
            box-shadow:var(--sh-sm);font-weight:600}
        .tab-btn:hover:not(.active){color:var(--text-2);background:rgba(0,0,0,.04)}
        .tab-pane{display:none}
        .tab-pane.active{display:block}

        /* ========= SUMMARY CARDS ========= */
        .summary-cards{display:flex;gap:14px;margin-bottom:20px;flex-wrap:wrap}
        .summary-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--r-md);
            padding:14px 18px;min-width:130px;border-left:3px solid var(--border-strong);
            box-shadow:var(--sh-sm)}
        .summary-card .label{font-size:.72rem;color:var(--text-3);text-transform:uppercase;letter-spacing:.05em;font-weight:600}
        .summary-card .value{font-size:1.5rem;font-weight:700;color:var(--text);margin-top:4px;letter-spacing:-.02em}
        .summary-card.danger{border-left-color:var(--danger)}
        .summary-card.danger .value{color:var(--danger)}
        .summary-card.success{border-left-color:var(--success)}
        .summary-card.success .value{color:var(--success)}
        .summary-card.info{border-left-color:var(--primary)}
        .summary-card.info .value{color:var(--primary)}
        .summary-card.warn{border-left-color:var(--warning)}
        .summary-card.warn .value{color:var(--warning-d)}

        /* ========= MODAL ========= */
        .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;
            justify-content:center;align-items:center;z-index:200;backdrop-filter:blur(4px)}
        .modal-content{background:var(--surface);border:1px solid var(--border);
            padding:28px;border-radius:var(--r-xl);width:440px;max-width:92vw;
            box-shadow:var(--sh-xl)}
        .modal-content h3{font-size:1rem;font-weight:700;margin-bottom:20px;color:var(--text)}
        .modal-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:24px}

        /* ========= TOAST ========= */
        .toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
            background:var(--header);color:#e2e8f0;padding:10px 20px;
            border-radius:var(--r-lg);font-size:.85rem;z-index:300;
            box-shadow:0 8px 24px rgba(0,0,0,.25),0 2px 8px rgba(0,0,0,.15);
            border:1px solid rgba(255,255,255,.1);font-weight:500;white-space:nowrap}

        /* ========= MISC ========= */
        .loading{text-align:center;padding:40px;color:var(--text-3)}
        .diff-neg{color:var(--danger);font-weight:600}
        .diff-pos{color:var(--success);font-weight:600}
        .loading-overlay{position:fixed;inset:0;background:rgba(248,250,252,.9);
            backdrop-filter:blur(4px);display:flex;flex-direction:column;
            justify-content:center;align-items:center;z-index:250}
        .spinner{width:44px;height:44px;border:3px solid var(--border);
            border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
        .loading-overlay p{margin-top:16px;font-size:.95rem;color:var(--text-2);font-weight:500;max-width:300px;text-align:center}

        /* ========= FILTERS ========= */
        .filter-row{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
        .filter-row select,.filter-row input[type=text]{padding:7px 10px;border:1.5px solid var(--border);
            border-radius:var(--r-sm);font-size:.82rem;background:var(--surface);
            color:var(--text);font-family:inherit;outline:none;transition:border .2s}
        .filter-row select:focus,.filter-row input[type=text]:focus{border-color:var(--primary)}
        .filter-row select{min-width:140px;max-width:200px}
        .filter-row input[type=text]{width:180px}

        /* ========= SECTION VISIBILITY ========= */
        .admin-section{display:none}
        .admin-section.active{display:block}

        @media(max-width:768px){
            .main-content{padding:12px}
            .summary-cards{flex-direction:column}
            .filter-row{flex-direction:column}
            .filter-row select,.filter-row input[type=text]{width:100%}
            .app-nav{padding:0 8px;overflow-x:auto;-webkit-overflow-scrolling:touch}
            .app-nav-btn{padding:8px 10px;font-size:.8rem}
            .app-header-top{padding:10px 12px}
            .nav-tabs{width:auto}
        }
    </style>
</head>
<body>

<!-- Login -->
<div id="loginPage" class="login-page">
    <div class="login-box">
        <div class="login-logo">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
                <path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>
            </svg>
        </div>
        <h1>Inventario Pro</h1>
        <p class="subtitle">Panel de Administracion</p>
        <div class="form-group">
            <label for="loginUser">Usuario</label>
            <input type="text" id="loginUser" placeholder="Codigo de empleado" autocomplete="username">
        </div>
        <div class="form-group">
            <label for="loginPass">PIN</label>
            <input type="password" id="loginPass" placeholder="••••••" autocomplete="current-password"
                   onkeydown="if(event.key==='Enter') A.login()">
        </div>
        <button class="btn btn-primary btn-block" onclick="A.login()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:16px;height:16px">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                <polyline points="10 17 15 12 10 7"/>
                <line x1="15" x2="3" y1="12" y2="12"/>
            </svg>
            Iniciar sesion
        </button>
        <p id="loginError" class="error-text" style="display:none">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;flex-shrink:0">
                <circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>
            </svg>
            <span></span>
        </p>
    </div>
</div>

<!-- App -->
<div id="appPage" style="display:none">
    <header class="app-header">
        <div class="app-header-top">
            <div class="app-brand">
                <div class="app-brand-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
                        <path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/>
                    </svg>
                </div>
                <h2>Inventario Pro</h2>
            </div>
            <div class="right">
                <span id="headerUser"></span>
                <button class="btn-header" onclick="A.logout()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" x2="9" y1="12" y2="12"/>
                    </svg>
                    Salir
                </button>
            </div>
        </div>
        <nav class="app-nav" id="appNav">
            <button class="app-nav-btn active" data-nav="inventarios" onclick="A.navigate('inventarios')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><path d="M9 14l2 2 4-4"/></svg>
                Inventarios
            </button>
            <button class="app-nav-btn" data-nav="maestra" onclick="A.navigate('maestra')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22V12"/></svg>
                Maestra
                <span id="maestraBadge" class="nav-badge" style="display:none"></span>
            </button>
            <button class="app-nav-btn" data-nav="log" onclick="A.navigate('log')">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/></svg>
                Log
            </button>
            <div class="nav-sep"></div>
            <!-- Breadcrumb for inventory detail -->
            <div class="breadcrumb" id="navBreadcrumb" style="display:none">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                <span class="breadcrumb-current" id="breadcrumbText"></span>
            </div>
            <div class="nav-spacer"></div>
            <span id="maestraInfo" style="font-size:.75rem;color:#64748b"></span>
        </nav>
    </header>

    <div class="main-content">

        <!-- ===== SECTION: INVENTARIOS ===== -->
        <div id="section-inventarios" class="admin-section active">
            <div class="actions-bar">
                <button class="btn btn-primary btn-lg" onclick="A.showCrear()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                    Nuevo Inventario
                </button>
                <button class="btn" onclick="A.loadInventarios()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    Actualizar
                </button>
            </div>

            <!-- Inventarios List -->
            <div class="card">
                <h3>Inventarios</h3>
                <div class="table-scroll">
                    <table>
                        <thead><tr>
                            <th>ID</th><th>Tienda</th><th>Fecha</th><th>Estado</th><th>Stock</th><th>Lecturas</th><th>Acciones</th>
                        </tr></thead>
                        <tbody id="tbInventarios"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ===== SECTION: MAESTRA ===== -->
        <div id="section-maestra" class="admin-section">
            <div class="actions-bar">
                <button class="btn btn-warning btn-lg" onclick="A.refreshMaestra()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                    Actualizar Maestra
                </button>
            </div>
            <div class="card">
                <div class="card-header">
                    <h3>Maestra de Productos (Cache del Servidor)</h3>
                </div>
                <div id="maestraSummary" class="summary-cards"></div>
                <div class="filter-row" id="maestraFilters">
                    <input type="text" id="maestraFilter" placeholder="Buscar SKU, ALU, descripcion..." oninput="A.applyMaestraFilters()">
                    <select id="filterMModelo" onchange="A.applyMaestraFilters()"><option value="">-- Modelo --</option></select>
                    <select id="filterMProveedor" onchange="A.applyMaestraFilters()"><option value="">-- Proveedor --</option></select>
                    <select id="filterMTemporada" onchange="A.applyMaestraFilters()"><option value="">-- Temporada --</option></select>
                    <button class="btn btn-sm" onclick="A.clearMaestraFilters()">Limpiar filtros</button>
                </div>
                <p id="maestraShowCount" style="font-size:.8rem;color:#6b7280;margin-bottom:8px"></p>
                <div class="table-scroll">
                    <table>
                        <thead><tr>
                            <th>SKU</th><th>ALU</th><th>Descripcion</th><th>Modelo</th><th>Proveedor</th><th>Temporada</th><th>CodCaja</th>
                        </tr></thead>
                        <tbody id="tbMaestra"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ===== SECTION: INVENTARIO DETAIL ===== -->
        <div id="section-detail" class="admin-section">
            <div class="nav-tabs" id="navTabs">
                <button class="tab-btn active" data-tab="stock" onclick="A.showTab('stock')">Stock Teorico</button>
                <button class="tab-btn" data-tab="monitor" onclick="A.showTab('monitor')">Monitor en Vivo</button>
                <button class="tab-btn" data-tab="reporte" onclick="A.showTab('reporte')">Reporte</button>
            </div>

            <!-- Stock Tab -->
            <div id="tab-stock" class="tab-pane active">
                <div class="card">
                    <div class="card-header">
                        <div class="tools">
                            <button class="btn btn-danger" id="btnDeleteSel" onclick="A.deleteSelected()" style="display:none">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                Eliminar seleccionados (<span id="selCount">0</span>)
                            </button>
                            <button class="btn btn-ghost" id="btnCambiar" onclick="A.cambiarTienda()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
                                Cambiar Tienda
                            </button>
                            <button class="btn btn-success" id="btnIniciar" onclick="A.iniciar()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                Iniciar Inventario
                            </button>
                            <button class="btn btn-primary" id="btnRefreshConteo" onclick="A.loadStock()" style="display:none">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                                Actualizar Conteo
                            </button>
                        </div>
                    </div>
                    <div id="stockSummary" class="summary-cards"></div>
                    <div class="filter-row" id="stockFilters">
                        <input type="text" id="stockFilter" placeholder="Buscar SKU, ALU..." oninput="A.applyStockFilters()">
                        <select id="filterDepto" onchange="A.applyStockFilters()"><option value="">-- Departamento --</option></select>
                        <select id="filterModelo" onchange="A.applyStockFilters()"><option value="">-- Modelo --</option></select>
                        <select id="filterProveedor" onchange="A.applyStockFilters()"><option value="">-- Proveedor --</option></select>
                        <select id="filterTemporada" onchange="A.applyStockFilters()"><option value="">-- Temporada --</option></select>
                        <button class="btn btn-sm" onclick="A.clearStockFilters()">Limpiar filtros</button>
                    </div>
                    <div class="table-scroll">
                        <table>
                            <thead><tr>
                                <th><input type="checkbox" id="chkAll" onchange="A.toggleAll(this.checked)"></th><th>SKU</th><th>ALU</th><th>Descripcion</th><th>Depto</th><th>Modelo</th><th>Proveedor</th><th>Temporada</th><th>Stock</th><th>Conteo</th><th>Dif</th><th></th>
                            </tr></thead>
                            <tbody id="tbStock"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Monitor Tab -->
            <div id="tab-monitor" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <div class="tools">
                            <span id="monitorStatus" style="font-size:.8rem;color:var(--text-3);display:flex;align-items:center;gap:5px">
                                <span style="width:7px;height:7px;border-radius:50%;background:#10b981;display:inline-block;animation:pulse 2s infinite"></span>
                                Actualizando cada 10s
                            </span>
                        </div>
                        <div class="tools">
                            <button class="btn btn-danger" id="btnCerrar" onclick="A.cerrar()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                Cerrar Inventario
                            </button>
                        </div>
                    </div>
                    <div id="monitorSummary" class="summary-cards"></div>
                    <div class="table-scroll">
                        <table>
                            <thead><tr>
                                <th>SKU</th><th>ALU</th><th>Descripcion</th><th>Cant</th><th>Ubic</th><th>Dispositivo</th><th>Origen</th><th>Hora</th>
                            </tr></thead>
                            <tbody id="tbMonitor"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reporte Tab -->
            <div id="tab-reporte" class="tab-pane">
                <div class="card">
                    <div class="card-header">
                        <div class="tools">
                            <input type="text" id="reporteFilter" placeholder="Filtrar..." oninput="A.filterReporte()">
                        </div>
                        <div class="tools">
                            <button class="btn btn-success" onclick="A.exportExcel()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                            Exportar Excel
                        </button>
                        </div>
                    </div>
                    <div id="reporteSummary" class="summary-cards"></div>
                    <div class="table-scroll">
                        <table>
                            <thead><tr>
                                <th>SKU</th><th>ALU</th><th>Descripcion</th><th>Depto</th><th>Proveedor</th>
                                <th>St.Teorico</th><th>Conteo</th><th>Diferencia</th>
                                <th>Costo</th><th>Precio</th><th>Dif.Costo</th><th>Dif.Precio</th>
                            </tr></thead>
                            <tbody id="tbReporte"></tbody>
                            <tfoot id="tfReporte"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== SECTION: LOG ===== -->
        <div id="section-log" class="admin-section">
            <div class="card">
                <div class="card-header">
                    <h3>Log de Actividad del Sistema</h3>
                    <div class="tools">
                        <span id="logCount" style="font-size:.82rem;color:var(--text-3)"></span>
                        <button class="btn btn-sm" onclick="A.loadLog()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>
                            Actualizar
                        </button>
                    </div>
                </div>
                <p style="font-size:.82rem;color:#6b7280;margin-bottom:12px">Registro de acciones del sistema. Solo lectura — maximo 500 entradas en memoria.</p>
                <div class="table-scroll">
                    <table>
                        <thead><tr>
                            <th style="width:160px">Fecha/Hora</th>
                            <th style="width:100px">Tipo</th>
                            <th>Mensaje</th>
                            <th style="width:120px">Usuario</th>
                        </tr></thead>
                        <tbody id="tbLog"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Create Modal -->
<div id="crearModal" class="modal" style="display:none">
    <div class="modal-content">
        <h3>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;vertical-align:-3px;margin-right:6px;color:var(--primary)"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
            Nuevo Inventario
        </h3>
        <div class="form-group">
            <label for="selectTienda">Tienda</label>
            <select id="selectTienda"><option value="">Cargando tiendas...</option></select>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-ghost" onclick="A.hideCrear()">Cancelar</button>
            <button class="btn btn-primary" id="btnCrear" onclick="A.crear()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="width:14px;height:14px"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                Crear y Cargar Stock
            </button>
        </div>
        <p id="crearStatus" style="font-size:.85rem;color:#6b7280;margin-top:8px"></p>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display:none">
    <div class="spinner"></div>
    <p id="loadingMsg">Cargando...</p>
</div>

<!-- Toast -->
<div id="toast" class="toast" style="display:none"></div>

<script>
const API = '';
let monitorTimer = null;

const A = {
    invId: null,
    invEstado: null,
    invNombre: '',
    stockData: [],
    reporteData: [],
    maestraData: [],
    currentSection: 'inventarios',

    // --- Navigation ---
    navigate(section) {
        // Stop monitor polling when leaving detail
        if (this.currentSection === 'detail' && section !== 'detail') {
            if (monitorTimer) { clearInterval(monitorTimer); monitorTimer = null; }
        }

        this.currentSection = section;

        // Hide all sections, show target
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        const target = document.getElementById('section-' + section);
        if (target) target.classList.add('active');

        // Update nav buttons
        document.querySelectorAll('.app-nav-btn').forEach(b => b.classList.remove('active'));
        const navBtn = document.querySelector(`.app-nav-btn[data-nav="${section}"]`);
        if (navBtn) navBtn.classList.add('active');
        // For detail, highlight inventarios in nav
        if (section === 'detail') {
            const invBtn = document.querySelector('.app-nav-btn[data-nav="inventarios"]');
            if (invBtn) invBtn.classList.add('active');
        }

        // Show/hide breadcrumb
        const bc = document.getElementById('navBreadcrumb');
        if (section === 'detail' && this.invNombre) {
            bc.style.display = 'flex';
            document.getElementById('breadcrumbText').textContent = `#${this.invId} - ${this.invNombre}`;
        } else {
            bc.style.display = 'none';
        }

        // Auto-load section data
        if (section === 'inventarios') this.loadInventarios();
        if (section === 'maestra') this.loadMaestraSection();
        if (section === 'log') this.loadLog();
    },

    // --- Login ---
    async login() {
        const user = document.getElementById('loginUser').value.trim();
        const pass = document.getElementById('loginPass').value.trim();
        const err = document.getElementById('loginError');
        const errSpan = err.querySelector('span') || err;
        const showErr = (msg) => { errSpan.textContent = msg; err.style.display = 'flex'; };
        err.style.display = 'none';
        if (!user || !pass) { showErr('Complete ambos campos'); return; }
        try {
            const r = await fetch(API + '/api/login', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user, password: pass})
            });
            const d = await r.json();
            if (d.success) {
                sessionStorage.setItem('admin_user', user);
                document.getElementById('headerUser').textContent = d.message;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appPage').style.display = 'block';
                this.navigate('inventarios');
                this.loadMaestraInfo();
            } else {
                showErr(d.message);
            }
        } catch (e) {
            showErr('Error de conexion al servidor');
        }
    },

    logout() {
        sessionStorage.clear();
        if (monitorTimer) clearInterval(monitorTimer);
        document.getElementById('appPage').style.display = 'none';
        document.getElementById('loginPage').style.display = 'flex';
        this.currentSection = 'inventarios';
    },

    // --- Inventarios ---
    async loadInventarios() {
        try {
            const r = await fetch(API + '/api/inventarios');
            const data = await r.json();
            const tb = document.getElementById('tbInventarios');
            tb.innerHTML = data.map(i => {
                const escapedName = (i.NombreTienda || '').replace(/'/g, "\\'");
                return `<tr>
                <td>${i.Id}</td>
                <td>${i.NombreTienda} (${i.CodTienda})</td>
                <td>${this.fmtDate(i.FechaCreacion)}</td>
                <td><span class="badge badge-${i.Estado}">${i.Estado}</span></td>
                <td>${i.TotalStock}</td>
                <td>${i.TotalLecturas}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="A.selectInv(${i.Id},'${i.Estado}','${escapedName}')">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                        Ver
                    </button>
                    <button class="btn btn-sm btn-ghost" onclick="A.deleteInv(${i.Id},'${escapedName}')" style="color:var(--danger);border-color:transparent" onmouseover="this.style.background='var(--danger-bg)'" onmouseout="this.style.background='transparent'">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                        Eliminar
                    </button>
                </td>
            </tr>`;
            }).join('');
        } catch (e) { this.toast('Error cargando inventarios'); }
    },

    async deleteInv(id, nombre) {
        if (!confirm(`ELIMINAR inventario #${id} - ${nombre}?\n\nSe borraran TODOS los datos: stock teorico y lecturas.\nEsta accion no se puede deshacer.`)) return;
        this.showLoading('Eliminando inventario...');
        try {
            await fetch(API + `/api/inventario/${id}`, {method:'DELETE'});
            this.hideLoading();
            if (this.invId === id) {
                this.invId = null;
                this.navigate('inventarios');
            }
            this.loadInventarios();
            this.toast('Inventario eliminado');
        } catch (e) { this.hideLoading(); this.toast('Error eliminando inventario'); }
    },

    async selectInv(id, estado, nombre) {
        this.invId = id;
        this.invEstado = estado;
        this.invNombre = nombre;
        if (monitorTimer) { clearInterval(monitorTimer); monitorTimer = null; }
        document.getElementById('btnIniciar').style.display = estado === 'preparacion' ? '' : 'none';
        document.getElementById('btnCerrar').style.display = estado === 'activo' ? '' : 'none';
        document.getElementById('btnRefreshConteo').style.display = (estado === 'activo' || estado === 'cerrado') ? '' : 'none';
        this.navigate('detail');
        if (estado === 'preparacion') this.showTab('stock');
        else if (estado === 'activo') this.showTab('monitor');
        else this.showTab('reporte');
    },

    showTab(tab) {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        document.querySelector(`.tab-btn[data-tab="${tab}"]`).classList.add('active');
        if (tab === 'stock') this.loadStock();
        else if (tab === 'monitor') this.startMonitor();
        else if (tab === 'reporte') this.loadReporte();
        if (tab !== 'monitor' && monitorTimer) { clearInterval(monitorTimer); monitorTimer = null; }
    },

    // --- Loading ---
    showLoading(msg) {
        document.getElementById('loadingMsg').textContent = msg || 'Cargando...';
        document.getElementById('loadingOverlay').style.display = 'flex';
    },
    hideLoading() {
        document.getElementById('loadingOverlay').style.display = 'none';
    },

    // --- Stock ---
    async loadStock() {
        if (!this.invId) return;
        try {
            const r = await fetch(API + `/api/inventario/${this.invId}/stock`);
            this.stockData = await r.json();

            // Load conteo data if inventory is active or closed
            if (this.invEstado === 'activo' || this.invEstado === 'cerrado') {
                try {
                    const lr = await fetch(API + `/api/inventario/${this.invId}/lecturas`);
                    const lecturas = await lr.json();
                    // Group by SKU: sum Cantidad
                    const conteoMap = {};
                    for (const l of lecturas) {
                        const key = String(l.SKU || '');
                        conteoMap[key] = (conteoMap[key] || 0) + (l.Cantidad || 0);
                    }
                    // Merge into stockData
                    for (const row of this.stockData) {
                        const key = String(row.SKU || '');
                        row._conteo = conteoMap[key] || 0;
                        row._dif = row._conteo - row.StockTeorico;
                    }
                } catch (e) { console.warn('Error cargando conteo:', e); }
            } else {
                for (const row of this.stockData) {
                    row._conteo = 0;
                    row._dif = 0 - row.StockTeorico;
                }
            }

            this.buildStockFilterOptions();
            this.applyStockFilters();
            if (this.invEstado === 'activo' || this.invEstado === 'cerrado') {
                this.toast('Conteo actualizado');
            }
        } catch (e) { this.toast('Error cargando stock'); }
    },

    buildStockFilterOptions() {
        const deptos = [...new Set(this.stockData.map(r => r.Departamento||'').filter(Boolean))].sort();
        const modelos = [...new Set(this.stockData.map(r => r.Modelo||'').filter(Boolean))].sort();
        const proveedores = [...new Set(this.stockData.map(r => r.Proveedor||'').filter(Boolean))].sort();
        const temporadas = [...new Set(this.stockData.map(r => r.Temporada||'').filter(Boolean))].sort();

        const fill = (id, items) => {
            const sel = document.getElementById(id);
            const current = sel.value;
            sel.innerHTML = `<option value="">${sel.options[0].textContent}</option>` +
                items.map(v => `<option value="${v}" ${v===current?'selected':''}>${v}</option>`).join('');
        };
        fill('filterDepto', deptos);
        fill('filterModelo', modelos);
        fill('filterProveedor', proveedores);
        fill('filterTemporada', temporadas);
    },

    applyStockFilters() {
        const q = (document.getElementById('stockFilter').value || '').toLowerCase();
        const depto = document.getElementById('filterDepto').value;
        const modelo = document.getElementById('filterModelo').value;
        const prov = document.getElementById('filterProveedor').value;
        const temp = document.getElementById('filterTemporada').value;

        const filtered = this.stockData.filter(r => {
            if (q && !((r.SKU||'').toString().toLowerCase().includes(q) || (r.ALU||'').toLowerCase().includes(q) ||
                (r.Descripcion||'').toLowerCase().includes(q))) return false;
            if (depto && (r.Departamento||'') !== depto) return false;
            if (modelo && (r.Modelo||'') !== modelo) return false;
            if (prov && (r.Proveedor||'') !== prov) return false;
            if (temp && (r.Temporada||'') !== temp) return false;
            return true;
        });
        this.renderStock(filtered);
    },

    clearStockFilters() {
        document.getElementById('stockFilter').value = '';
        document.getElementById('filterDepto').value = '';
        document.getElementById('filterModelo').value = '';
        document.getElementById('filterProveedor').value = '';
        document.getElementById('filterTemporada').value = '';
        this.renderStock(this.stockData);
    },

    renderStock(data) {
        this._filteredStock = data;
        const totalStock = data.reduce((s, r) => s + r.StockTeorico, 0);
        const totalAllStock = this.stockData.reduce((s, r) => s + r.StockTeorico, 0);
        const totalConteo = data.reduce((s, r) => s + (r._conteo || 0), 0);
        const totalAllConteo = this.stockData.reduce((s, r) => s + (r._conteo || 0), 0);
        const totalDif = totalConteo - totalStock;
        const showConteo = this.invEstado === 'activo' || this.invEstado === 'cerrado';
        document.getElementById('stockSummary').innerHTML = `
            <div class="summary-card"><div class="label">Mostrando</div><div class="value">${data.length} / ${this.stockData.length}</div></div>
            <div class="summary-card"><div class="label">Stock Teorico</div><div class="value">${totalAllStock.toLocaleString()}</div></div>
            ${showConteo ? `
            <div class="summary-card"><div class="label">Conteo Total</div><div class="value" style="color:#4ade80">${totalAllConteo.toLocaleString()}</div></div>
            <div class="summary-card"><div class="label">Diferencia</div><div class="value" style="color:${totalDif < 0 ? '#f87171' : '#4ade80'}">${totalDif > 0 ? '+' : ''}${totalDif.toLocaleString()}</div></div>
            <div class="summary-card"><div class="label">Progreso</div><div class="value">${totalAllStock > 0 ? Math.round(totalAllConteo / totalAllStock * 100) : 0}%</div></div>
            ` : `<div class="summary-card"><div class="label">Total unidades</div><div class="value">${totalAllStock.toLocaleString()}</div></div>`}`;
        const canEdit = this.invEstado === 'preparacion';
        document.getElementById('tbStock').innerHTML = data.map(r => {
            const dif = (r._conteo || 0) - r.StockTeorico;
            const difColor = dif < 0 ? '#f87171' : dif > 0 ? '#fb923c' : '#4ade80';
            const difText = dif > 0 ? '+' + dif : dif;
            return `<tr>
            <td>${canEdit ? `<input type="checkbox" class="chk-stock" value="${r.Id}" onchange="A.updateSelCount()">` : ''}</td>
            <td>${r.SKU}</td><td>${r.ALU||''}</td><td>${r.Descripcion||''}</td>
            <td>${r.Departamento||''}</td><td>${r.Modelo||''}</td><td>${r.Proveedor||''}</td><td>${r.Temporada||''}</td><td>${r.StockTeorico}</td>
            <td style="font-weight:600;color:#4ade80">${r._conteo || 0}</td>
            <td style="font-weight:600;color:${difColor}">${difText}</td>
            <td>${canEdit ? `<button class="btn-icon-del" onclick="A.deleteStock(${r.Id})" title="Eliminar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button>` : ''}</td>
        </tr>`}).join('');
        document.getElementById('chkAll').checked = false;
        this.updateSelCount();
    },

    toggleAll(checked) {
        document.querySelectorAll('.chk-stock').forEach(c => c.checked = checked);
        this.updateSelCount();
    },

    updateSelCount() {
        const checked = document.querySelectorAll('.chk-stock:checked');
        const btn = document.getElementById('btnDeleteSel');
        document.getElementById('selCount').textContent = checked.length;
        btn.style.display = checked.length > 0 ? '' : 'none';
    },

    async deleteStock(stockId) {
        if (!confirm('Eliminar este producto del stock teorico?')) return;
        try {
            await fetch(API + `/api/inventario/${this.invId}/stock/${stockId}`, {method:'DELETE'});
            this.stockData = this.stockData.filter(r => r.Id !== stockId);
            this.buildStockFilterOptions();
            this.applyStockFilters();
            this.toast('Producto eliminado');
        } catch (e) { this.toast('Error eliminando'); }
    },

    async deleteSelected() {
        const checked = document.querySelectorAll('.chk-stock:checked');
        const ids = [...checked].map(c => parseInt(c.value));
        if (ids.length === 0) return;
        if (!confirm(`Eliminar ${ids.length} productos del stock teorico?\n\nEsta accion no se puede deshacer.`)) return;
        this.showLoading(`Eliminando ${ids.length} productos...`);
        try {
            await fetch(API + `/api/inventario/${this.invId}/stock/eliminar-lote`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify(ids)
            });
            this.hideLoading();
            this.stockData = this.stockData.filter(r => !ids.includes(r.Id));
            this.buildStockFilterOptions();
            this.applyStockFilters();
            this.toast(`${ids.length} productos eliminados`);
        } catch (e) { this.hideLoading(); this.toast('Error eliminando lote'); }
    },

    cambiarTienda() {
        if (!confirm('Desea cancelar este inventario y crear uno nuevo con otra tienda?')) return;
        this.navigate('inventarios');
        this.showCrear();
    },

    async iniciar() {
        if (!confirm('Iniciar inventario? Las PDAs podran escanear.')) return;
        try {
            await fetch(API + `/api/inventario/${this.invId}/iniciar`, {method:'PUT'});
            this.invEstado = 'activo';
            document.getElementById('btnIniciar').style.display = 'none';
            document.getElementById('btnCerrar').style.display = '';
            document.getElementById('btnRefreshConteo').style.display = '';
            this.loadInventarios();
            this.showTab('monitor');
            this.toast('Inventario iniciado');
        } catch (e) { this.toast('Error iniciando'); }
    },

    // --- Monitor ---
    startMonitor() {
        this.loadLecturas();
        if (monitorTimer) clearInterval(monitorTimer);
        monitorTimer = setInterval(() => this.loadLecturas(), 10000);
    },

    async loadLecturas() {
        if (!this.invId) return;
        try {
            const r = await fetch(API + `/api/inventario/${this.invId}/lecturas`);
            const data = await r.json();
            const totalQty = data.reduce((s, r) => s + r.Cantidad, 0);
            const totalPistola = data.filter(r => (r.Origen || 'scanner') !== 'manual').reduce((s, r) => s + r.Cantidad, 0);
            const totalManual = data.filter(r => r.Origen === 'manual').reduce((s, r) => s + r.Cantidad, 0);
            const devices = {};
            data.forEach(r => { devices[r.Dispositivo] = (devices[r.Dispositivo]||0) + r.Cantidad; });
            let summaryHtml = `
                <div class="summary-card info"><div class="label">Total Unidades</div><div class="value">${totalQty}</div></div>
                <div class="summary-card"><div class="label">Registros</div><div class="value">${data.length}</div></div>
                <div class="summary-card success"><div class="label">Pistola</div><div class="value">${totalPistola}</div></div>
                <div class="summary-card warn"><div class="label">Manuales</div><div class="value">${totalManual}</div></div>`;
            for (const [dev, qty] of Object.entries(devices)) {
                summaryHtml += `<div class="summary-card"><div class="label">${dev}</div><div class="value">${qty}</div></div>`;
            }
            document.getElementById('monitorSummary').innerHTML = summaryHtml;
            document.getElementById('tbMonitor').innerHTML = data.map(r => {
                const origen = r.Origen || 'scanner';
                const origenBadge = origen === 'manual'
                    ? '<span style="background:var(--warning-bg);color:var(--warning-d);padding:2px 8px;border-radius:20px;font-size:.72rem;font-weight:600">Manual</span>'
                    : '<span style="background:var(--success-bg);color:var(--success-d);padding:2px 8px;border-radius:20px;font-size:.72rem;font-weight:600">Scanner</span>';
                return `<tr>
                <td>${r.SKU}</td><td>${r.ALU||''}</td><td>${r.Descripcion||''}</td>
                <td><b>${r.Cantidad}</b></td><td>${r.Ubicacion||'-'}</td><td>${r.Dispositivo}</td>
                <td>${origenBadge}</td>
                <td style="color:var(--text-3)">${this.fmtDate(r.FechaHora)}</td>
            </tr>`;
            }).join('');
        } catch (e) { console.error(e); }
    },

    async cerrar() {
        if (!confirm('Cerrar inventario? Ya no se podran enviar mas lecturas.')) return;
        try {
            await fetch(API + `/api/inventario/${this.invId}/cerrar`, {method:'PUT'});
            this.invEstado = 'cerrado';
            if (monitorTimer) { clearInterval(monitorTimer); monitorTimer = null; }
            document.getElementById('btnCerrar').style.display = 'none';
            this.loadInventarios();
            this.showTab('reporte');
            this.toast('Inventario cerrado');
        } catch (e) { this.toast('Error cerrando'); }
    },

    // --- Reporte ---
    async loadReporte() {
        if (!this.invId) return;
        try {
            const r = await fetch(API + `/api/inventario/${this.invId}/reporte`);
            this.reporteData = await r.json();
            this.renderReporte(this.reporteData);
        } catch (e) { this.toast('Error cargando reporte'); }
    },

    renderReporte(data) {
        let totSt=0,totCo=0,totDif=0,totDC=0,totDP=0;
        data.forEach(r => { totSt+=r.StockTeorico; totCo+=r.Conteo; totDif+=r.Diferencia; totDC+=r.DifCosto; totDP+=r.DifPrecio; });
        document.getElementById('reporteSummary').innerHTML = `
            <div class="summary-card"><div class="label">Productos</div><div class="value">${data.length}</div></div>
            <div class="summary-card"><div class="label">Stock Teorico</div><div class="value">${totSt}</div></div>
            <div class="summary-card"><div class="label">Conteo</div><div class="value">${totCo}</div></div>
            <div class="summary-card ${totDif<0?'danger':'success'}"><div class="label">Diferencia</div><div class="value">${totDif}</div></div>
            <div class="summary-card danger"><div class="label">Dif. Costo</div><div class="value">S/${totDC.toFixed(2)}</div></div>
            <div class="summary-card danger"><div class="label">Dif. Precio</div><div class="value">S/${totDP.toFixed(2)}</div></div>`;
        document.getElementById('tbReporte').innerHTML = data.map(r => {
            const dc = r.Diferencia < 0 ? 'diff-neg' : r.Diferencia > 0 ? 'diff-pos' : '';
            const sobranteBadge = r.Sobrante ? ' <span style="background:#f59e0b;color:#000;font-size:.68rem;font-weight:700;padding:1px 5px;border-radius:4px;vertical-align:middle">SOBRANTE</span>' : '';
            const rowStyle = r.Sobrante ? ' style="background:rgba(245,158,11,.06)"' : '';
            return `<tr${rowStyle}>
                <td>${r.SKU}</td><td>${r.ALU||''}</td><td>${r.Descripcion||''}${sobranteBadge}</td>
                <td>${r.Departamento||''}</td><td>${r.Proveedor||''}</td>
                <td>${r.StockTeorico}</td><td>${r.Conteo}</td><td class="${dc}">${r.Diferencia}</td>
                <td>S/${r.Costo.toFixed(2)}</td><td>S/${r.Precio.toFixed(2)}</td>
                <td class="${dc}">S/${r.DifCosto.toFixed(2)}</td><td class="${dc}">S/${r.DifPrecio.toFixed(2)}</td>
            </tr>`;
        }).join('');
        document.getElementById('tfReporte').innerHTML = `<tr>
            <td colspan="5"><b>TOTALES</b></td>
            <td><b>${totSt}</b></td><td><b>${totCo}</b></td><td class="${totDif<0?'diff-neg':'diff-pos'}"><b>${totDif}</b></td>
            <td></td><td></td><td class="diff-neg"><b>S/${totDC.toFixed(2)}</b></td><td class="diff-neg"><b>S/${totDP.toFixed(2)}</b></td>
        </tr>`;
    },

    filterReporte() {
        const q = document.getElementById('reporteFilter').value.toLowerCase();
        const filtered = this.reporteData.filter(r =>
            (r.SKU||'').toLowerCase().includes(q) || (r.ALU||'').toLowerCase().includes(q) ||
            (r.Descripcion||'').toLowerCase().includes(q) || (r.Departamento||'').toLowerCase().includes(q));
        this.renderReporte(filtered);
    },

    exportExcel() {
        if (!this.reporteData.length) { this.toast('No hay datos para exportar'); return; }
        const ws = XLSX.utils.json_to_sheet(this.reporteData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Reporte');
        XLSX.writeFile(wb, `Reporte_Inventario_${this.invId}.xlsx`);
        this.toast('Excel descargado');
    },

    // --- Crear Inventario ---
    async showCrear() {
        document.getElementById('crearModal').style.display = 'flex';
        document.getElementById('crearStatus').textContent = 'Cargando tiendas...';
        try {
            const r = await fetch(API + '/api/tiendas');
            const tiendas = await r.json();
            const sel = document.getElementById('selectTienda');
            sel.innerHTML = '<option value="">Seleccionar tienda...</option>' +
                tiendas.map(t => `<option value="${t.StoreNo}" data-name="${t.tienda}">${t.StoreNo} - ${t.tienda}</option>`).join('');
            document.getElementById('crearStatus').textContent = '';
        } catch (e) {
            document.getElementById('crearStatus').textContent = 'Error cargando tiendas';
        }
    },

    hideCrear() { document.getElementById('crearModal').style.display = 'none'; },

    async crear() {
        const sel = document.getElementById('selectTienda');
        const cod = sel.value;
        const nombre = sel.options[sel.selectedIndex]?.dataset?.name || '';
        if (!cod) { this.toast('Seleccione una tienda'); return; }

        this.hideCrear();
        this.showLoading(`Creando inventario para ${nombre}... Cargando stock teorico desde el sistema.`);
        try {
            const r = await fetch(API + '/api/inventario', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({cod_tienda: cod, nombre_tienda: nombre})
            });
            const d = await r.json();
            this.hideLoading();
            if (d.success) {
                this.toast(`Inventario creado: ${d.productos_cargados} productos cargados`);
                this.loadInventarios();
                this.selectInv(d.inventario_id, 'preparacion', nombre);
            } else {
                this.toast('Error creando inventario');
            }
        } catch (e) {
            this.hideLoading();
            this.toast('Error de conexion al crear inventario');
        }
    },

    // --- Maestra ---
    async loadMaestraSection() {
        if (this.maestraData.length > 0) {
            this.buildMaestraFilterOptions();
            this.applyMaestraFilters();
            return;
        }
        this.showLoading('Descargando maestra de productos...');
        try {
            const [mr, vr] = await Promise.all([
                fetch(API + '/api/maestra'),
                fetch(API + '/api/maestra/version')
            ]);
            this.maestraData = await mr.json();
            const version = await vr.json();
            this.hideLoading();
            document.getElementById('maestraSummary').innerHTML = `
                <div class="summary-card"><div class="label">Total Productos</div><div class="value">${this.maestraData.length.toLocaleString()}</div></div>
                <div class="summary-card"><div class="label">Hash</div><div class="value" style="font-size:.9rem">${version.hash}</div></div>
                <div class="summary-card"><div class="label">Actualizado</div><div class="value" style="font-size:.9rem">${version.timestamp ? this.fmtDate(version.timestamp) : '-'}</div></div>`;
            this.buildMaestraFilterOptions();
            this.applyMaestraFilters();
        } catch (e) {
            this.hideLoading();
            this.toast('Error descargando maestra');
        }
    },

    buildMaestraFilterOptions() {
        const modelos = [...new Set(this.maestraData.map(r => r.modelo || '').filter(Boolean))].sort();
        const proveedores = [...new Set(this.maestraData.map(r => r.proveedor || '').filter(Boolean))].sort();
        const temporadas = [...new Set(this.maestraData.map(r => r.temporada || '').filter(Boolean))].sort();

        const fill = (id, items) => {
            const sel = document.getElementById(id);
            const current = sel.value;
            sel.innerHTML = `<option value="">${sel.options[0].textContent}</option>` +
                items.map(v => `<option value="${v}" ${v === current ? 'selected' : ''}>${v}</option>`).join('');
        };
        fill('filterMModelo', modelos);
        fill('filterMProveedor', proveedores);
        fill('filterMTemporada', temporadas);
    },

    applyMaestraFilters() {
        const q = (document.getElementById('maestraFilter').value || '').toLowerCase();
        const modelo = document.getElementById('filterMModelo').value;
        const prov = document.getElementById('filterMProveedor').value;
        const temp = document.getElementById('filterMTemporada').value;

        const filtered = this.maestraData.filter(r => {
            if (q && !((r.SKU || '').toString().toLowerCase().includes(q) || (r.ALU || '').toLowerCase().includes(q) ||
                (r.descripcion || '').toLowerCase().includes(q))) return false;
            if (modelo && (r.modelo || '') !== modelo) return false;
            if (prov && (r.proveedor || '') !== prov) return false;
            if (temp && (r.temporada || '') !== temp) return false;
            return true;
        });

        const showing = Math.min(filtered.length, 500);
        document.getElementById('maestraShowCount').textContent = `Mostrando ${showing.toLocaleString()} de ${filtered.length.toLocaleString()} productos filtrados (total: ${this.maestraData.length.toLocaleString()})`;
        document.getElementById('tbMaestra').innerHTML = filtered.slice(0, 500).map(r => `<tr>
            <td>${r.SKU || ''}</td><td>${r.ALU || ''}</td><td>${r.descripcion || ''}</td>
            <td>${r.modelo || ''}</td><td>${r.proveedor || ''}</td><td>${r.temporada || ''}</td><td>${r.codcaja || ''}</td>
        </tr>`).join('');
    },

    clearMaestraFilters() {
        document.getElementById('maestraFilter').value = '';
        document.getElementById('filterMModelo').value = '';
        document.getElementById('filterMProveedor').value = '';
        document.getElementById('filterMTemporada').value = '';
        this.applyMaestraFilters();
    },

    async loadMaestraInfo() {
        try {
            const r = await fetch(API + '/api/maestra/version');
            const d = await r.json();
            document.getElementById('maestraInfo').textContent = `${d.count.toLocaleString()} productos`;
            const badge = document.getElementById('maestraBadge');
            badge.textContent = d.count.toLocaleString();
            badge.style.display = '';
        } catch (e) {
            document.getElementById('maestraInfo').textContent = '';
        }
    },

    async refreshMaestra() {
        if (!confirm('Actualizar maestra de productos desde la base de datos?\n\nEsto puede tomar unos segundos.')) return;
        this.showLoading('Actualizando maestra de productos...');
        try {
            const r = await fetch(API + '/api/maestra/refresh', {method: 'POST'});
            const d = await r.json();
            this.hideLoading();
            if (d.success) {
                this.maestraData = []; // Clear cache to force reload
                this.toast(d.message);
                this.loadMaestraInfo();
                if (this.currentSection === 'maestra') this.loadMaestraSection();
            } else {
                this.toast('Error actualizando maestra');
            }
        } catch (e) {
            this.hideLoading();
            this.toast('Error de conexion al actualizar maestra');
        }
    },

    // --- Log ---
    async loadLog() {
        try {
            const r = await fetch(API + '/api/log');
            const data = await r.json();
            document.getElementById('logCount').textContent = `${data.length} entradas`;
            const typeStyle = {
                login:        'background:#dbeafe;color:#1e40af',
                inventario:   'background:#d1fae5;color:#065f46',
                sync:         'background:#fef3c7;color:#92400e',
                delete:       'background:#fee2e2;color:#991b1b',
                maestra:      'background:#ede9fe;color:#5b21b6',
                error:        'background:#fee2e2;color:#991b1b',
                'pda-sync':   'background:#ecfdf5;color:#065f46',
                'pda-delete': 'background:#fff7ed;color:#9a3412',
                'pda-error':  'background:#fee2e2;color:#991b1b',
                'pda-info':   'background:#f0f9ff;color:#075985'
            };
            const typeLabel = {
                login: 'LOGIN', inventario: 'INVENTARIO', sync: 'SYNC SERVER',
                delete: 'BORRADO', maestra: 'MAESTRA', error: 'ERROR',
                'pda-sync': 'PDA SYNC', 'pda-delete': 'PDA BORRAR',
                'pda-error': 'PDA ERROR', 'pda-info': 'PDA INFO'
            };
            document.getElementById('tbLog').innerHTML = data.length === 0
                ? '<tr><td colspan="4" class="loading">Sin actividad registrada</td></tr>'
                : data.map(r => {
                    const style = typeStyle[r.tipo] || 'background:var(--surface-2);color:var(--text-2)';
                    const label = typeLabel[r.tipo] || (r.tipo||'').toUpperCase();
                    return `<tr>
                        <td style="font-size:.78rem;white-space:nowrap;color:var(--text-3)">${this.fmtDate(r.timestamp)}</td>
                        <td><span style="${style};padding:2px 9px;border-radius:20px;font-size:.72rem;font-weight:700;display:inline-block">${label}</span></td>
                        <td style="font-size:.83rem;color:var(--text)">${r.mensaje||''}</td>
                        <td style="font-size:.8rem;color:var(--text-3)">${r.usuario||'-'}</td>
                    </tr>`;
                }).join('');
        } catch (e) { this.toast('Error cargando log'); }
    },

    // --- Utils ---
    toast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    },

    fmtDate(d) {
        if (!d) return '';
        const dt = new Date(d);
        const opts = {timeZone: 'America/Lima'};
        return dt.toLocaleDateString('es-PE', opts) + ' ' + dt.toLocaleTimeString('es-PE', {...opts, hour:'2-digit', minute:'2-digit'});
    }
};

// Check session on load
if (sessionStorage.getItem('admin_user')) {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('appPage').style.display = 'block';
    A.navigate('inventarios');
    A.loadMaestraInfo();
}

// Enter key on login
document.getElementById('loginPass').addEventListener('keydown', e => { if (e.key === 'Enter') A.login(); });
</script>
</body>
</html>
